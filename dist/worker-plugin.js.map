{"version":3,"file":"worker-plugin.js","sources":["../src/index.js"],"sourcesContent":["/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport path from 'path';\nimport ParserHelpers from 'webpack/lib/ParserHelpers';\nimport WORKER_PLUGIN_SYMBOL from './symbol';\n\nconst NAME = 'WorkerPlugin';\nconst JS_TYPES = ['auto', 'esm', 'dynamic'];\nconst workerLoader = path.resolve(__dirname, 'loader.js');\n\nexport default class WorkerPlugin {\n  constructor (options) {\n    this.options = options || {};\n    this[WORKER_PLUGIN_SYMBOL] = true;\n  }\n\n  apply (compiler) {\n    compiler.hooks.normalModuleFactory.tap(NAME, factory => {\n      for (const type of JS_TYPES) {\n        factory.hooks.parser.for(`javascript/${type}`).tap(NAME, parser => {\n          let workerId = 0;\n\n          parser.hooks.new.for('Worker').tap(NAME, expr => {\n            const dep = parser.evaluateExpression(expr.arguments[0]);\n\n            if (!dep.isString()) {\n              parser.state.module.warnings.push({\n                message: 'new Worker() will only be bundled if passed a String.'\n              });\n              return false;\n            }\n\n            const optsExpr = expr.arguments[1];\n            let typeModuleExpr;\n            let opts;\n            if (optsExpr) {\n              opts = {};\n              for (let i = optsExpr.properties.length; i--;) {\n                const prop = optsExpr.properties[i];\n                if (prop.type === 'Property' && !prop.computed && !prop.shorthand && !prop.method) {\n                  opts[prop.key.name] = parser.evaluateExpression(prop.value).string;\n\n                  if (prop.key.name === 'type') {\n                    typeModuleExpr = prop;\n                  }\n                }\n              }\n            }\n\n            if (!opts || opts.type !== 'module') {\n              parser.state.module.warnings.push({\n                message: `new Worker() will only be bundled if passed options that include { type: 'module' }.${opts ? `\\n  Received: new Worker(${JSON.stringify(dep.string)}, ${JSON.stringify(opts)})` : ''}`\n              });\n              return false;\n            }\n\n            let loaderOptions = opts.name && { name: opts.name };\n            const req = `require(${JSON.stringify(workerLoader + (loaderOptions ? ('?' + JSON.stringify(loaderOptions)) : '') + '!' + dep.string)})`;\n            const id = `__webpack__worker__${++workerId}`;\n            ParserHelpers.toConstantDependency(parser, id)(expr.arguments[0]);\n\n            if (this.options.workerType) {\n              ParserHelpers.toConstantDependency(parser, JSON.stringify(this.options.workerType))(typeModuleExpr.value);\n            } else if (this.options.preserveTypeModule !== true) {\n              ParserHelpers.toConstantDependency(parser, '')(typeModuleExpr);\n            }\n\n            return ParserHelpers.addParsedVariableToModule(parser, id, req);\n          });\n        });\n      }\n    });\n  }\n}\n"],"names":["const","NAME","JS_TYPES","workerLoader","path","resolve","__dirname","WorkerPlugin","constructor","options","WORKER_PLUGIN_SYMBOL","apply","compiler","hooks","normalModuleFactory","tap","factory","type","parser","for","workerId","new","expr","dep","evaluateExpression","arguments","isString","state","module","warnings","push","optsExpr","typeModuleExpr","opts","let","i","properties","length","prop","computed","shorthand","method","key","name","value","string","JSON","stringify","loaderOptions","req","id","ParserHelpers","toConstantDependency","this","workerType","preserveTypeModule","addParsedVariableToModule"],"mappings":"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"}