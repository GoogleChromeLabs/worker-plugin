{"version":3,"file":"loader.js","sources":["../src/loader.js"],"sourcesContent":["/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport loaderUtils from 'loader-utils';\nimport SingleEntryPlugin from 'webpack/lib/SingleEntryPlugin';\nimport WebWorkerTemplatePlugin from 'webpack/lib/webworker/WebWorkerTemplatePlugin';\nimport FetchCompileWasmTemplatePlugin from 'webpack/lib/web/FetchCompileWasmTemplatePlugin';\nimport WORKER_PLUGIN_SYMBOL from './symbol';\n\nconst NAME = 'WorkerPluginLoader';\nlet hasWarned = false;\n\nexport function pitch (request) {\n  this.cacheable(false);\n  const cb = this.async();\n\n  const compilerOptions = this._compiler.options || {};\n\n  const pluginOptions = compilerOptions.plugins.find(p => p[WORKER_PLUGIN_SYMBOL]).options;\n\n  if (pluginOptions.globalObject == null && !hasWarned && compilerOptions.output && compilerOptions.output.globalObject === 'window') {\n    hasWarned = true;\n    console.warn('Warning (worker-plugin): output.globalObject is set to \"window\". It must be set to \"self\" to support HMR in Workers.');\n  }\n\n  const options = loaderUtils.getOptions(this) || {};\n  const chunkFilename = compilerOptions.output.chunkFilename.replace(/\\.([a-z]+)$/i, '.worker.$1');\n  const workerOptions = {\n    filename: chunkFilename.replace(/\\[(?:chunkhash|contenthash)(:\\d+(?::\\d+)?)?\\]/g, '[hash$1]'),\n    chunkFilename,\n    globalObject: pluginOptions.globalObject || 'self'\n  };\n\n  const plugins = (pluginOptions.plugins || []).map(plugin => {\n    if (typeof plugin !== 'string') {\n      return plugin;\n    }\n    const found = compilerOptions.plugins.find(p => p.constructor.name === plugin);\n    if (!found) {\n      console.warn(`Warning (worker-plugin): Plugin \"${plugin}\" is not found.`);\n    }\n    return found;\n  });\n\n  const workerCompiler = this._compilation.createChildCompiler(NAME, workerOptions, plugins);\n  (new WebWorkerTemplatePlugin(workerOptions)).apply(workerCompiler);\n  (new FetchCompileWasmTemplatePlugin({\n    mangleImports: compilerOptions.optimization.mangleWasmImports\n  })).apply(workerCompiler);\n  (new SingleEntryPlugin(this.context, request, options.name)).apply(workerCompiler);\n\n  const subCache = `subcache ${__dirname} ${request}`;\n  workerCompiler.hooks.compilation.tap(NAME, compilation => {\n    if (compilation.cache) {\n      if (!compilation.cache[subCache]) compilation.cache[subCache] = {};\n      compilation.cache = compilation.cache[subCache];\n    }\n  });\n\n  workerCompiler.runAsChild((err, entries, compilation) => {\n    if (!err && compilation.errors && compilation.errors.length) {\n      err = compilation.errors[0];\n    }\n    const entry = entries && entries[0] && entries[0].files[0];\n    if (!err && !entry) err = Error(`WorkerPlugin: no entry for ${request}`);\n    if (err) return cb(err);\n    return cb(null, `module.exports = __webpack_public_path__ + ${JSON.stringify(entry)}`);\n  });\n};\n\nexport default { pitch };\n"],"names":["const","NAME","let","hasWarned","pitch","request","cacheable","cb","async","compilerOptions","_compiler","options","pluginOptions","plugins","find","p","WORKER_PLUGIN_SYMBOL","globalObject","output","console","warn","loaderUtils","getOptions","chunkFilename","replace","workerOptions","filename","map","plugin","found","constructor","name","workerCompiler","_compilation","createChildCompiler","WebWorkerTemplatePlugin","apply","FetchCompileWasmTemplatePlugin","mangleImports","optimization","mangleWasmImports","SingleEntryPlugin","context","subCache","__dirname","hooks","compilation","tap","cache","runAsChild","err","entries","errors","length","entry","files","Error","JSON","stringify"],"mappings":"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"}